# 환경별 설정 파일 관리하기

## 문제 상황

개발을 하다보면 로컬, 개발 서버, 운영 서버 마다 다른 설정을 필요로한다. 대표적인 예시가 DB 접속이다. 그리고 개발자에 따라서 윈도우, 맥 단위로 다른 경우도 있다. 이렇게 환경이 다를때 마다 매번 필요한 값을 수정하기 어려우니 속성 정보를 파일로 관리하면 좋다. 이번글에서는 대표적인 yml 파일로 관리하는 방법을 정리한다.

## 단일 파일 방식

1개의 파일에서 모든 정보를 정리한다. 예시는 다음과 같다.

```yml
# 공통 설정
spring:
  application:
    name: myapp

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false

server:
  port: 8080

---
# local 환경 설정
spring:
  config:
    activate:
      on-profile: local

  datasource:
    url: jdbc:mysql://localhost:3306/testdb
    username: root
    password: 1234
logging:
  level:
    com.myapp: DEBUG
---
# dev 환경 설정
spring:
  config:
    activate:
      on-profile: dev

  datasource:
    url: jdbc:mysql://dev-db-server:3306/devdb
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
logging:
  level:
    com.myapp: INFO
---
# prod 환경 설정
spring:
  config:
    activate:
      on-profile: prod

  datasource:
    url: jdbc:mysql://prod-db-server:3306/proddb
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
logging:
  level:
    com.myapp: WARN
```

간단한 프로젝트에서는 항목이 많지 않으니 이렇게 관리해도 이슈가 없다. 하지만 시스템이 커지고 상세 설정이 많으면 1개의 파일로는 가독성도 떨어지고 관리가 어렵다. 과거에 local 환경에서 변경해야하는 항목을 dev 환경에서 변경하고 왜 적용이 안되는지 한참 찾은 경험도 있다.

## 파일 분리 방식

필요한 환경에서 사용하는 정보를 파일 단위로 분리한다. 예시는 다음과 같다.

- application.yml (공통 설정)

    ```yml
    spring:
        application:
            name: myapp

        jpa:
            hibernate:
            ddl-auto: validate
            show-sql: false

    server:
    port: 8080
    ```

- application-local.yml (로컬 환경)

    ```yml
    spring:
        datasource:
            url: jdbc:mysql://localhost:3306/testdb
            username: root
            password: 1234
    logging:
        level:
            com.myapp: DEBUG
    ```

- application-dev.yml (개발 서버)

    ```yml
    spring:
        datasource:
            url: jdbc:mysql://dev-db-server:3306/devdb
            username: root
            password: 1234
    logging:
        level:
            com.myapp: INFO
    ```

- application-prod.yml (개발 서버)

    ```yml
    spring:
        datasource:
            url: jdbc:mysql://prod-db-server:3306/proddb
            username: root
            password: 1234
    logging:
        level:
            com.myapp: WARN
    ```

파일이 여러개 생성 되어 선호하지 않는 경우도 있지만 개인적으로는 좀 더 명확한 관리를 위해 이 방식을 선호한다.

## Profile 적용 방법

여러 가지 방법이 있는데 대표적인 방법 몇 가지를 정리해 보자

### 1. 로컬 개발 시 (IntelliJ IDEA)

Run Configuration 설정:

- Run → Edit Configurations
- Environment variables 또는 VM options에 추가
- VM options: -Dspring.profiles.active=local
- Program arguments: --spring.profiles.active=local

### 2. JAR 실행 시

```bash
# 방법 1: JVM 옵션
java -jar -Dspring.profiles.active=prod myapp.jar

# 방법 2: 프로그램 인자
java -jar myapp.jar --spring.profiles.active=prod

# 방법 3: 환경 변수
export SPRING_PROFILES_ACTIVE=prod
java -jar myapp.jar
```

### 3. Docker 환경

```docker
FROM openjdk:17-jdk-slim
COPY target/myapp.jar app.jar
ENV SPRING_PROFILES_ACTIVE=prod
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

또는

```bash
docker run -e SPRING_PROFILES_ACTIVE=prod myapp-image
```

### 4. 배포 스크립트

```bash
#!/bin/bash
# deploy-prod.sh

APP_NAME=myapp
JAR_FILE=/app/$APP_NAME.jar
PROFILE=prod

java -jar \
  -Dspring.profiles.active=$PROFILE \
  -Xmx1024m \
  -Xms512m \
  $JAR_FILE
```
