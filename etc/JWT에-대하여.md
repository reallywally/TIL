# JWTì— ëŒ€í•˜ì—¬

## JWTëž€?

JWT(JSON Web Token)ëŠ” ì¸ì¦ê³¼ ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ì „ë‹¬í•˜ê¸° ìœ„í•œ í† í° ê¸°ë°˜ ì¸ì¦ ë°©ì‹ì´ë‹¤. í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚¼ ë•Œ JWTë¥¼ í¬í•¨í•˜ë©´ ì„œë²„ëŠ” ì´ë¥¼ ê²€ì¦í•˜ì—¬ ì‚¬ìš©ìžì˜ ì‹ ì›ì„ í™•ì¸í•˜ê³  ê¶Œí•œì„ ë¶€ì—¬í•  ìˆ˜ ìžˆë‹¤.

### ì™œ JWTë¥¼ ì‚¬ìš©í• ê¹Œ?

ì „í†µì ì¸ ì„¸ì…˜ ê¸°ë°˜ ì¸ì¦ì€ ì„œë²„ì— ì‚¬ìš©ìž ì •ë³´ë¥¼ ì €ìž¥í•´ì•¼ í•˜ì§€ë§Œ, JWTëŠ” í† í° ìžì²´ì— ì •ë³´ë¥¼ ë‹´ì•„ **stateless(ë¬´ìƒíƒœ)** ë°©ì‹ìœ¼ë¡œ ë™ìž‘í•œë‹¤. ì´ëŠ” ì„œë²„ì˜ ë¶€ë‹´ì„ ì¤„ì´ê³  í™•ìž¥ì„±ì„ ë†’ì´ëŠ” ë° ìœ ë¦¬í•˜ë‹¤.

**ì„¸ì…˜ vs JWT ë¹„êµ:**

- **ì„¸ì…˜**: ì„œë²„ ë©”ëª¨ë¦¬ë‚˜ DBì— ì‚¬ìš©ìž ì •ë³´ ì €ìž¥ â†’ ì„œë²„ ë¶€í•˜ ì¦ê°€, ì—¬ëŸ¬ ì„œë²„ ê°„ ë™ê¸°í™” í•„ìš”
- **JWT**: í† í° ìžì²´ì— ì •ë³´ í¬í•¨ â†’ ì„œë²„ëŠ” ê²€ì¦ë§Œ ìˆ˜í–‰, ìˆ˜í‰ í™•ìž¥ì— ìœ ë¦¬

## JWTì˜ êµ¬ì„± ìš”ì†Œ

JWTëŠ” `Header.Payload.Signature`ì™€ ê°™ì´ .(ì ) ë‹¨ìœ„ë¡œ 3ê°€ì§€ êµ¬ì„± ìš”ì†Œë¡œ ì´ë£¨ì–´ì ¸ ìžˆë‹¤.

ì‹¤ì œ JWT ì˜ˆì‹œ:

```text
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwicm9sZSI6IlVTRVIiLCJpYXQiOjE3MTAxMTUyMDAsImV4cCI6MTcxMDEyMjQwMH0.xYz123...
```

ê° ë¶€ë¶„ì€ Base64Urlë¡œ ì¸ì½”ë”©ë˜ì–´ ìžˆìœ¼ë©°, ë””ì½”ë”©í•˜ë©´ ì›ëž˜ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìžˆë‹¤.

### 1. Header(í—¤ë”)

í† í° ìœ í˜•ê³¼ ì„œëª…ì— ì‚¬ìš©í•  ì•Œê³ ë¦¬ì¦˜ ì •ë³´ë¥¼ ë‹´ëŠ”ë‹¤.

```json
{
   "typ": "JWT",
   "alg": "HS256"
}
```

**ì£¼ìš” ì•Œê³ ë¦¬ì¦˜:**

- `HS256`: HMAC + SHA256 (ëŒ€ì¹­í‚¤ ë°©ì‹, ê°™ì€ ë¹„ë°€í‚¤ë¡œ ì„œëª…/ê²€ì¦)
- `RS256`: RSA + SHA256 (ë¹„ëŒ€ì¹­í‚¤ ë°©ì‹, ê°œì¸í‚¤ë¡œ ì„œëª…, ê³µê°œí‚¤ë¡œ ê²€ì¦)

### 2. Payload(íŽ˜ì´ë¡œë“œ)

ì‚¬ìš©ìž ì •ë³´ì™€ ì¶”ê°€ì ì¸ claim(í´ë ˆìž„)ì„ í¬í•¨í•œë‹¤. í´ë ˆìž„ì´ëž€ í† í°ì— ë‹´ê¸°ëŠ” ì •ë³´ì˜ í•œ ì¡°ê°ì„ ì˜ë¯¸í•˜ë©°, Key-Value í˜•íƒœë¡œ êµ¬ì„±ëœë‹¤.

```json
{
  "sub": "user@example.com",
  "role": "USER",
  "iat": 1710115200,
  "exp": 1710122400
}
```

#### í‘œì¤€ í´ë ˆìž„ (Registered Claims)

í´ë ˆìž„ì´ í•„ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ JWT í‘œì¤€ ìŠ¤íŽ™(RFC 7519)ìœ¼ë¡œ ê¶Œìž¥ë˜ëŠ” í´ë ˆìž„ë“¤ì´ ìžˆë‹¤:

1. `iss` (Issuer): í† í° ë°œê¸‰ìž
2. `sub` (Subject): í† í° ì œëª© (ë³´í†µ ì‚¬ìš©ìž ì‹ë³„ìž)
3. `aud` (Audience): í† í° ëŒ€ìƒìž
4. `exp` (Expiration Time): í† í° ë§Œë£Œ ì‹œê°„ (Unix timestamp)
5. `nbf` (Not Before): í† í° í™œì„± ì‹œìž‘ ì‹œê°„
6. `iat` (Issued At): í† í° ë°œê¸‰ ì‹œê°„
7. `jti` (JWT ID): JWT ê³ ìœ  ì‹ë³„ìž

#### Custom Claim ì‚¬ìš© ì‹œ ì£¼ì˜ì‚¬í•­

í•„ìš”ì— ë”°ë¼ `role`, `permissions`, `userId` ê°™ì€ ì»¤ìŠ¤í…€ í´ë ˆìž„ì„ ì¶”ê°€í•  ìˆ˜ ìžˆë‹¤. í•˜ì§€ë§Œ **JWTëŠ” ì•”í˜¸í™”ë˜ì§€ ì•Šê³  ë‹¨ìˆœížˆ Base64Url ì¸ì½”ë”©ë§Œ ë˜ì–´ ìžˆì–´** ëˆ„êµ¬ë‚˜ ë””ì½”ë”©í•˜ë©´ ë‚´ìš©ì„ ë³¼ ìˆ˜ ìžˆë‹¤.

**âš ï¸ ì ˆëŒ€ í¬í•¨í•˜ë©´ ì•ˆ ë˜ëŠ” ì •ë³´:**

- ë¹„ë°€ë²ˆí˜¸
- ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸
- ì‹ ìš©ì¹´ë“œ ì •ë³´
- ê°œì¸ ë¯¼ê°ì •ë³´

**ðŸ’¡ ì‹¤ë¬´ íŒ:** Payload í¬ê¸°ê°€ ì»¤ì§€ë©´ ë§¤ ìš”ì²­ë§ˆë‹¤ ì „ì†¡ë˜ëŠ” ë°ì´í„°ëŸ‰ì´ ì¦ê°€í•œë‹¤. í•„ìš”í•œ ìµœì†Œí•œì˜ ì •ë³´ë§Œ ë‹´ìž.

### 3. Signature(ì„œëª…)

Headerì™€ Payloadë¥¼ ì¡°í•©í•˜ê³  ë¹„ë°€í‚¤ë¡œ ì„œëª…í•˜ì—¬ ìƒì„±í•œë‹¤. ì´ ì„œëª…ì„ í†µí•´ í† í°ì´ ë³€ì¡°ë˜ì§€ ì•Šì•˜ìŒì„ ê²€ì¦í•  ìˆ˜ ìžˆë‹¤.

```text
HMACSHA256(
    base64UrlEncode(header) + "." + base64UrlEncode(payload),
    secret
)
```

**ì„œëª…ì˜ ì—­í• :**

1. **ë¬´ê²°ì„± ê²€ì¦**: í† í°ì´ ì¤‘ê°„ì— ë³€ì¡°ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
2. **ë°œê¸‰ìž ì¸ì¦**: ì˜¬ë°”ë¥¸ ì„œë²„ì—ì„œ ë°œê¸‰í•œ í† í°ì¸ì§€ í™•ì¸

ë§Œì•½ ê³µê²©ìžê°€ Payloadì˜ `role`ì„ `USER`ì—ì„œ `ADMIN`ìœ¼ë¡œ ë³€ê²½í•˜ë ¤ í•´ë„, ë¹„ë°€í‚¤ ì—†ì´ëŠ” ì˜¬ë°”ë¥¸ ì„œëª…ì„ ë§Œë“¤ ìˆ˜ ì—†ì–´ ì„œë²„ê°€ ì´ë¥¼ ê±°ë¶€í•œë‹¤.

## Access Tokenê³¼ Refresh Token

ì‹¤ë¬´ì—ì„œ JWTë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” ë³´í†µ ë‘ ì¢…ë¥˜ì˜ í† í°ì„ í•¨ê»˜ ì‚¬ìš©í•œë‹¤.

### Access Token (ì•¡ì„¸ìŠ¤ í† í°)

ì‹¤ì œ API ìš”ì²­ ì‹œ ì‚¬ìš©í•˜ëŠ” í† í°ìœ¼ë¡œ, **ì§§ì€ ë§Œë£Œ ì‹œê°„**(15ë¶„~1ì‹œê°„)ì„ ê°€ì§„ë‹¤.

**íŠ¹ì§•:**

- ë§¤ API ìš”ì²­ë§ˆë‹¤ í—¤ë”ì— í¬í•¨ë˜ì–´ ì „ì†¡
- ë§Œë£Œ ì‹œê°„ì´ ì§§ì•„ íƒˆì·¨ë˜ì–´ë„ í”¼í•´ ìµœì†Œí™”
- ì„œë²„ëŠ” ì´ í† í°ì„ ê²€ì¦í•´ì„œ ì‚¬ìš©ìž ì¸ì¦/ê¶Œí•œ í™•ì¸

### Refresh Token (ë¦¬í”„ë ˆì‹œ í† í°)

Access Tokenì´ ë§Œë£Œë˜ì—ˆì„ ë•Œ **ìƒˆë¡œìš´ Access Tokenì„ ë°œê¸‰ë°›ê¸° ìœ„í•œ** í† í°ìœ¼ë¡œ, **ê¸´ ë§Œë£Œ ì‹œê°„**(2ì£¼~1ê°œì›”)ì„ ê°€ì§„ë‹¤.

**íŠ¹ì§•:**

- Access Token ìž¬ë°œê¸‰ ìš©ë„ë¡œë§Œ ì‚¬ìš©
- ì¼ë°˜ API ìš”ì²­ì—ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- HttpOnly Cookieì— ì•ˆì „í•˜ê²Œ ì €ìž¥
- DBì— ì €ìž¥í•´ì„œ ê°•ì œ ë¬´íš¨í™” ê°€ëŠ¥

### ì™œ ë‘ ê°œë¥¼ ë‚˜ëˆ ì„œ ì‚¬ìš©í• ê¹Œ?

**í•˜ë‚˜ë§Œ ì‚¬ìš©í•˜ë©´ ìƒê¸°ëŠ” ë¬¸ì œ:**

1. **ë§Œë£Œ ì‹œê°„ì´ ê¸´ í† í° í•˜ë‚˜ë§Œ ì‚¬ìš©í•  ê²½ìš°**
   - í† í°ì´ íƒˆì·¨ë˜ë©´ ì˜¤ëžœ ì‹œê°„ ì•…ìš© ê°€ëŠ¥
   - ë³´ì•ˆ ìœ„í—˜ì´ ë†’ìŒ

2. **ë§Œë£Œ ì‹œê°„ì´ ì§§ì€ í† í° í•˜ë‚˜ë§Œ ì‚¬ìš©í•  ê²½ìš°**
   - ì‚¬ìš©ìžê°€ 15ë¶„ë§ˆë‹¤ ìž¬ë¡œê·¸ì¸í•´ì•¼ í•¨
   - ì‚¬ìš©ìž ê²½í—˜(UX)ì´ ë§¤ìš° ë‚˜ì¨

**Access + Refresh Token ì¡°í•©ì˜ ìž¥ì :**

- Access Tokenì´ íƒˆì·¨ë˜ì–´ë„ ì§§ì€ ì‹œê°„ë§Œ ì•…ìš© ê°€ëŠ¥
- Refresh Tokenìœ¼ë¡œ ìžë™ìœ¼ë¡œ ìƒˆ Access Token ë°œê¸‰
- ì‚¬ìš©ìžëŠ” ìž¬ë¡œê·¸ì¸ ì—†ì´ ì„œë¹„ìŠ¤ë¥¼ ê³„ì† ì´ìš© ê°€ëŠ¥
- Refresh Tokenì€ DBì— ì €ìž¥í•´ì„œ í•„ìš”ì‹œ ê°•ì œ ë¬´íš¨í™” ê°€ëŠ¥

ê·¸ë¦¬ê³  í•­ìƒ ê·¸ë ‡ë“¯ Access + Refresh Token ì¡°í•©ì´ ì •ë‹µì€ ì•„ë‹ˆë‹¤. ë“£ê¸°ë¡œëŠ” ì‹œìŠ¤í…œ íŠ¹ì„±ê³¼ ì‹¤ì œ ì‚¬ìš©ìž í™˜ê²½ìƒ Access Token 1ê°œì˜ ë§Œë£Œ ì‹œê°„ì„ ê¸¸ê²Œí•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ë„ ìžˆì—ˆë‹¤.

### ë™ìž‘ íë¦„

```text
[ìµœì´ˆ ë¡œê·¸ì¸]
1. Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Server
          (ID/PW)

2. Client <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Server
          (Access Token + Refresh Token)

[ì¼ë°˜ API ìš”ì²­]
3. Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Server
          (Authorization: Bearer <Access Token>)

4. Client <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Server
          (ë°ì´í„°)

[Access Token ë§Œë£Œ ì‹œ]
5. Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Server
          (Authorization: Bearer <ë§Œë£Œëœ Access Token>)

6. Client <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Server
          (401 Unauthorized - í† í° ë§Œë£Œ)

7. Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Server
          (Refresh Tokenìœ¼ë¡œ ìž¬ë°œê¸‰ ìš”ì²­)

8. Client <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Server
          (ìƒˆë¡œìš´ Access Token)

9. Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Server
          (Authorization: Bearer <ìƒˆ Access Token>)

10. Client <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Server
           (ë°ì´í„°)
```

### ì‹¤ì „ êµ¬í˜„ ì˜ˆì œ

**ë¡œê·¸ì¸ ì‹œ ë‘ í† í° ë°œê¸‰:**

```javascript
function login(req, res) {
  const user = authenticateUser(req.body); // ì‚¬ìš©ìž ì¸ì¦

  // Access Token: 15ë¶„
  const accessToken = jwt.sign(
    { userId: user.id, role: user.role },
    process.env.ACCESS_TOKEN_SECRET,
    { expiresIn: '15m' }
  );

  // Refresh Token: 7ì¼
  const refreshToken = jwt.sign(
    { userId: user.id },
    process.env.REFRESH_TOKEN_SECRET,
    { expiresIn: '7d' }
  );

  // Refresh Tokenì„ DBì— ì €ìž¥ (ë‚˜ì¤‘ì— ë¬´íš¨í™” ê°€ëŠ¥í•˜ë„ë¡)
  saveRefreshTokenToDatabase(user.id, refreshToken);

  // Refresh Tokenì€ HttpOnly Cookieë¡œ ì „ì†¡ (XSS ë°©ì–´)
  res.cookie('refreshToken', refreshToken, {
    httpOnly: true,
    secure: true, // HTTPS only
    sameSite: 'strict',
    maxAge: 7 * 24 * 60 * 60 * 1000 // 7ì¼
  });

  // Access Tokenì€ ì‘ë‹µ ë³¸ë¬¸ìœ¼ë¡œ ì „ì†¡
  res.json({ accessToken });
}
```
